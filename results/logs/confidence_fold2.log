[LOG] Output is being logged to: /workspace/DFUMultiClassification/results/logs/confidence_fold2.log
[LOG] Started at: 2026-02-14 05:39:59


================================================================================
DEVICE CONFIGURATION (mode: multi)
================================================================================

Detected 2 GPU(s):
  GPU 0: NVIDIA RTX A5000 - 24.0GB (compute 8.6)
  GPU 1: NVIDIA RTX A5000 - 24.0GB (compute 8.6)

Selected 2 GPU(s):
  GPU 0: NVIDIA RTX A5000 (24.0GB)
  GPU 1: NVIDIA RTX A5000 (24.0GB)
Enabled memory growth for 2 GPU(s)

Using MirroredStrategy (2 GPUs) with NCCL
  Compute capability 8.6 detected (native NCCL support)
  (Using NCCL for fastest multi-GPU communication)
  Effective batch size: 2× global batch size
================================================================================


Batch size per replica: 16 (global batch size: 32, replicas: 2)

================================================================================
DFU MULTIMODAL CLASSIFICATION - PRODUCTION PIPELINE
================================================================================
Mode: search
Resume mode: auto
Data percentage: 100.0%
Verbosity: 2 (DETAILED)
Device: GPUs [0, 1] (multi-GPU mode, MirroredStrategy)
  Replicas: 2× batch size distribution
Cross-validation: 3-fold CV (patient-level)

Configuration loaded from: src/utils/production_config.py
Image size: 256x256
Batch size: 32
  Per-GPU batch: 16 (32 / 2 GPUs)
Max epochs: 200 (with early stopping)
Modality search mode: custom
Will test 1 custom combinations
================================================================================


✨ AUTO RESUME MODE: Keeping all checkpoints, will resume from latest state...
================================================================================

Data Cleaning Configuration (from production_config.py):
  Outlier removal: False
  Misclassification tracking: none
Outlier removal disabled
Confidence filtering disabled (DISABLE_CONFIDENCE_FILTERING=1)

================================================================================
MODALITY SEARCH MODE: CUSTOM (1 combinations)
================================================================================
Testing only specified combinations from production_config.py
Total combinations to test: 1
Cross-validation mode: 3-fold CV
Iterations per combination: 3
Total training sessions: 3
Results will be saved to: /workspace/DFUMultiClassification/results/csv/modality_combination_results.csv
================================================================================


Testing modalities: metadata
DEBUG CONF-FILTER: CONFIDENCE_EXCLUSION_FILE env = None
DEBUG CONF-FILTER: File exists = N/A
Number of samples for each selected modality:
  metadata: 3108
Using 100.0% of the data: 3108 samples
Using strategy from main: MirroredStrategy

================================================================================
MULTI-GPU TRAINING: 2 GPUs
Global batch size: 32 (per-GPU: 16)
Strategy: MirroredStrategy
================================================================================


================================================================================
GENERATING 3-FOLD CROSS-VALIDATION SPLITS (PATIENT-LEVEL)
================================================================================

================================================================================
STRATIFIED K-FOLD SPLIT - CLASS DISTRIBUTION CHECK
================================================================================
Class 0: 87 patients
Class 1: 115 patients
Class 2: 31 patients
================================================================================

Fold 1/3: 154 train patients, 79 valid patients
  Train dist: {0: 0.312, 1: 0.606, 2: 0.082}
  Valid dist: {0: 0.248, 1: 0.603, 2: 0.149}
Fold 2/3: 156 train patients, 77 valid patients
  Train dist: {0: 0.258, 1: 0.613, 2: 0.129}
  Valid dist: {0: 0.350, 1: 0.587, 2: 0.063}
Fold 3/3: 156 train patients, 77 valid patients
  Train dist: {0: 0.294, 1: 0.596, 2: 0.110}
  Valid dist: {0: 0.272, 1: 0.626, 2: 0.103}
Generated 3 folds
All data will be validated exactly once across all folds
================================================================================


Fold 1/3
Using pre-computed fold 1 patient split

Fold 1/3 skipped (target_fold=2). Loading saved results...
  Loaded 1 saved metric(s) for Fold 1/3

Fold 2/3
Using pre-computed fold 2 patient split
Processing metadata shape...

Unique cases: 518 (before oversampling)

True binary label distributions (unique cases):
Binary1: label_bin1
1    352
0    166
Name: count, dtype: int64
Binary2: label_bin2
0    457
1     61
Name: count, dtype: int64
Original class distribution (ordered):
Class 0: 728
Class 1: 1485
Class 2: 267

Calculated alpha values from original distribution:
Alpha values (ordered) [I, P, R]: [0.711, 0.349, 1.94]
Original class distribution (ordered):
Class 0: 728
Class 1: 1485
Class 2: 267
Using combined sampling (under + over)...

After undersampling (ordered):
Class 0: 728
Class 1: 728
Class 2: 267

After oversampling (ordered):
Class 0: 728
Class 1: 728
Class 2: 728

Alpha values after oversampling [I, P, R]: [1.0, 1.0, 1.0]
(Should be close to [1, 1, 1] since data is balanced)
Feature selection: 54 → 40 features
Top 5 features: ['Peri-Ulcer Temperature Normalized (°C)', 'Wound Centre Temperature Normalized (°C)', 'Onset (Days)', 'BMI', 'Weight (Kg)']
RF out-of-fold predictions (5-fold internal CV)

  RF standalone metrics (TRAIN (out-of-fold)):
    Accuracy: 0.9895  |  F1-macro: 0.9894  |  Kappa: 0.9842
Using 40 features from training selection

  RF standalone metrics (VALIDATION):
    Accuracy: 0.5939  |  F1-macro: 0.4397  |  Kappa: 0.1051
Healing Phase Abs type: <class 'numpy.ndarray'> shape: (2184,)
Healing Phase Abs type: <class 'numpy.ndarray'> shape: (628,)
  Validation batch size adjusted: 1 → 2 (n_samples=628, num_gpus=2)
Setting image shapes to 256x256...
Generative augmentation disabled

Preparing datasets for Fold 2/3 with all modalities: ['metadata']
Using consistent patient split across all modality combinations for run 2

Class distributions:
Training: {0: 0.258, 1: 0.613, 2: 0.129}
Validation: {0: 0.35, 1: 0.587, 2: 0.063}

Unique cases: 435 (before oversampling)

True binary label distributions (unique cases):
Binary1: label_bin1
1    311
0    124
Name: count, dtype: int64
Binary2: label_bin2
0    374
1     61
Name: count, dtype: int64
Original class distribution (ordered):
Class 0: 548
Class 1: 1301
Class 2: 273

Calculated alpha values from original distribution:
Alpha values (ordered) [I, P, R]: [0.875, 0.369, 1.756]
Original class distribution (ordered):
Class 0: 548
Class 1: 1301
Class 2: 273
Using combined sampling (under + over)...

After undersampling (ordered):
Class 0: 548
Class 1: 548
Class 2: 273

After oversampling (ordered):
Class 0: 548
Class 1: 548
Class 2: 548

Alpha values after oversampling [I, P, R]: [1.0, 1.0, 1.0]
(Should be close to [1, 1, 1] since data is balanced)
Feature selection: 54 → 40 features
Top 5 features: ['Wound Centre Temperature Normalized (°C)', 'Peri-Ulcer Temperature Normalized (°C)', 'Onset (Days)', 'BMI', 'Weight (Kg)']
RF out-of-fold predictions (5-fold internal CV)

  RF standalone metrics (TRAIN (out-of-fold)):
    Accuracy: 0.9805  |  F1-macro: 0.9805  |  Kappa: 0.9708
Using 40 features from training selection

  RF standalone metrics (VALIDATION):
    Accuracy: 0.6105  |  F1-macro: 0.3478  |  Kappa: 0.1277
Healing Phase Abs type: <class 'numpy.ndarray'> shape: (1644,)
Healing Phase Abs type: <class 'numpy.ndarray'> shape: (986,)
  Validation batch size adjusted: 32 → 32 (n_samples=986, num_gpus=2)
