2026-01-25 19:56:38,686 - INFO - ================================================================================
2026-01-25 19:56:38,686 - INFO - QUICK TEST MODE: 30.0% data, 3 epochs, 32x32 images
2026-01-25 19:56:38,686 - INFO - This is for error checking only - results not production-ready
2026-01-25 19:56:38,686 - INFO - ================================================================================

2026-01-25 19:56:38,687 - INFO - Saved original production_config values
2026-01-25 19:56:38,687 - INFO - Resuming test run - 1/2 tests completed
2026-01-25 19:56:38,687 - INFO - 
Skipping Baseline (no generative augmentation) (already completed)
2026-01-25 19:56:38,687 - INFO - 
================================================================================
2026-01-25 19:56:38,687 - INFO - Starting test 2/2
2026-01-25 19:56:38,687 - INFO - ================================================================================
2026-01-25 19:56:38,687 - INFO - 
================================================================================
2026-01-25 19:56:38,687 - INFO - TEST: With generative augmentation (depth_rgb)
2026-01-25 19:56:38,687 - INFO - ================================================================================
2026-01-25 19:56:38,687 - INFO - Deleted cached dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 19:56:38,687 - INFO - Deleted cached outliers: outliers_depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 19:56:38,688 - INFO - Config updated: USE_GENERATIVE_AUGMENTATION=True
2026-01-25 19:56:38,688 - INFO - Modalities: metadata, depth_rgb, depth_map, thermal_map
2026-01-25 19:56:38,688 - INFO - Running: /venv/multimodal/bin/python src/main.py --data_percentage 30.0 --resume_mode fresh --device-mode multi

COMMAND: /venv/multimodal/bin/python src/main.py --data_percentage 30.0 --resume_mode fresh --device-mode multi

2026-01-25 19:56:39.127253: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2026-01-25 19:56:39.127296: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2026-01-25 19:56:39.128009: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered

================================================================================
DEVICE CONFIGURATION (mode: multi)
================================================================================

Detected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 1: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 2: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 3: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 4: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)

Selected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 1: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 2: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 3: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 4: NVIDIA GeForce RTX 4090 (24.0GB)
Enabled memory growth for 5 GPU(s)

Using MirroredStrategy (5 GPUs) with NCCL
  Compute capability 8.9 detected (native NCCL support)
  (Using NCCL for fastest multi-GPU communication)
  Effective batch size: 5Ã— global batch size
================================================================================


Batch size per replica: 51 (global batch size: 256, replicas: 5)

================================================================================
DFU MULTIMODAL CLASSIFICATION - PRODUCTION PIPELINE
================================================================================
Mode: search
Resume mode: fresh
Data percentage: 30.0%
Verbosity: 1 (NORMAL)
Device: GPUs [0, 1, 2, 3, 4] (multi-GPU mode, MirroredStrategy)
  Replicas: 5Ã— batch size distribution
Cross-validation: 3-fold CV (patient-level)

Configuration loaded from: src/utils/production_config.py
Image size: 32x32
Batch size: 256
  Per-GPU batch: 51 (256 / 5 GPUs)
Max epochs: 3 (with early stopping)
Modality search mode: custom
Will test 1 custom combinations
================================================================================


ðŸ§¹ FRESH START MODE: Deleting all checkpoints...
================================================================================

Cleanup Statistics:
  Models: 2 files deleted
  Csv Results: 1 files deleted
  Tf Cache: 4 files deleted
================================================================================


Data Cleaning Configuration (from production_config.py):
  Outlier removal: True
  Outlier contamination: 15%
  Outlier batch size: 32
  Misclassification tracking: none

================================================================================
OUTLIER DETECTION AND REMOVAL (COMBINATION-SPECIFIC)
================================================================================
Contamination rate: 15%
Processing 1 modality combination(s)

[1/1] depth_map_depth_rgb_metadata_thermal_map
Detecting outliers for combination: depth_map_depth_rgb_metadata_thermal_map (contamination=15%)...
  Total outliers: 410/2729 (15.0%)
  Cleaned dataset: 2319 samples
  Saved cleaned dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
Applying cleaned dataset for depth_map_depth_rgb_metadata_thermal_map (15% outlier removal)...
  Filtered: 2729 samples
  Applied cleaned dataset to: best_matching.csv
  âœ“ Applied for depth_map_depth_rgb_metadata_thermal_map: 2319 samples

================================================================================


================================================================================
MODALITY SEARCH MODE: CUSTOM (1 combinations)
================================================================================
Testing only specified combinations from production_config.py
Total combinations to test: 1
Cross-validation mode: 3-fold CV
Iterations per combination: 3
Total training sessions: 3
Results will be saved to: /workspace/DFUMultiClassification/results/csv/modality_combination_results.csv
================================================================================


Testing modalities: metadata, depth_rgb, depth_map, thermal_map
Number of samples for each selected modality:
  depth_rgb: 2729
  depth_bb: 2729
  depth_map: 2729
  thermal_map: 2729
  thermal_bb: 2729
  metadata: 2729
Using 30.0% of the data: 819 samples

================================================================================
MULTI-GPU TRAINING: 5 GPUs
Global batch size: 256 (per-GPU: 51)
Strategy: MirroredStrategy
================================================================================


================================================================================
GENERATING 3-FOLD CROSS-VALIDATION SPLITS (PATIENT-LEVEL)
================================================================================

================================================================================
STRATIFIED K-FOLD SPLIT - CLASS DISTRIBUTION CHECK
================================================================================
Class 0: 58 patients
Class 1: 95 patients
Class 2: 20 patients
================================================================================

Fold 1/3: 114 train patients, 59 valid patients
  Train dist: {0: 0.266, 1: 0.628, 2: 0.106}
  Valid dist: {0: 0.302, 1: 0.610, 2: 0.088}
Fold 2/3: 115 train patients, 58 valid patients
  Train dist: {0: 0.301, 1: 0.622, 2: 0.078}
  Valid dist: {0: 0.239, 1: 0.621, 2: 0.139}
Fold 3/3: 117 train patients, 56 valid patients
  Train dist: {0: 0.272, 1: 0.616, 2: 0.112}
  Valid dist: {0: 0.299, 1: 0.636, 2: 0.065}
Generated 3 folds
All data will be validated exactly once across all folds
================================================================================


Fold 1/3
Using pre-computed fold 1 patient split
Using Scikit-learn RandomForestClassifier
Initializing GenerativeAugmentationManager with models from src/models/sdxl_checkpoints
âœ“ Found checkpoint: src/models/sdxl_checkpoints/checkpoint_best.pt
âœ“ Found config: /workspace/DFUMultiClassification/src/utils/full_sdxl_config.yaml
âœ“ SDXL paths configured (will load on first use to conserve resources)

Preparing datasets for Fold 1/3 with all modalities: ['thermal_map', 'depth_map', 'depth_rgb', 'metadata']
Using consistent patient split across all modality combinations for run 1
Using Scikit-learn RandomForestClassifier

No existing data found for metadata+depth_rgb+depth_map+thermal_map, starting fresh

Training metadata+depth_rgb+depth_map+thermal_map with modalities: ['metadata', 'depth_rgb', 'depth_map', 'thermal_map'], fold 1/3
================================================================================
AUTOMATIC PRE-TRAINING: depth_rgb weights not found
  Training depth_rgb-only model first (same data split)...
================================================================================

[GPU DEBUG] ========== PRE-TRAINING PHASE (depth_rgb) ==========
[GPU DEBUG] GPU usage: LOW (small CNN, 64x64 images)
[GPU DEBUG] SDXL NOT LOADED YET - will load during FUSION training
[GPU DEBUG] ==================================================

WARNING: All log messages before absl::InitializeLog() is called are written to STDERR
I0000 00:00:1769371227.045479 2311886 device_compiler.h:186] Compiled cluster using XLA!  This line is logged at most once for the lifetime of the process.

============================================================
[GPU DEBUG] SDXL GENERATOR FIRST USE - LOADING NOW!
[GPU DEBUG] This will take ~30-60 seconds and use ~10GB GPU memory
============================================================

Loading SDXL generator (first use)...
âœ“ SDXL generator loaded successfully

============================================================
[GPU DEBUG] SDXL LOADING - Expect HIGH GPU memory usage soon!
============================================================
Loading SDXL checkpoint from src/models/sdxl_checkpoints/checkpoint_best.pt
Loading base model: stabilityai/stable-diffusion-xl-base-1.0
`torch_dtype` is deprecated! Use `dtype` instead!
Loading trained UNet weights...
/venv/multimodal/lib/python3.11/site-packages/diffusers/pipelines/pipeline_utils.py:2186: FutureWarning: `enable_vae_slicing` is deprecated and will be removed in version 0.40.0. Calling `enable_vae_slicing()` on a `StableDiffusionXLPipeline` is deprecated and this method will be removed in a future version. Please use `pipe.vae.enable_slicing()`.
  deprecate(
SDXL pipeline loaded successfully on cuda
[GPU DEBUG] SDXL GENERATING: 8 images for phase P at 32x32
[GPU DEBUG] Using 50 inference steps - Expect HIGH GPU utilization!
/venv/multimodal/lib/python3.11/site-packages/diffusers/pipelines/stable_diffusion_xl/pipeline_stable_diffusion_xl.py:748: FutureWarning: `upcast_vae` is deprecated and will be removed in version 1.0.0. `upcast_vae` is deprecated. Please use `pipe.vae.to(torch.float32)`. For more details, please refer to: https://github.com/huggingface/diffusers/pull/12619#issue-3606633695.
  deprecate(
  Generated images: 8
[GPU DEBUG] SDXL GENERATING: 8 images for phase R at 32x32
[GPU DEBUG] Using 50 inference steps - Expect HIGH GPU utilization!
  Generated images: 16
[GPU DEBUG] SDXL GENERATING: 8 images for phase R at 32x32
[GPU DEBUG] Using 50 inference steps - Expect HIGH GPU utilization!
  Generated images: 24
  Pre-training completed! Best val kappa: 0.0000
2026-01-25 20:02:19,384 - INFO -     Pre-training completed! Best val kappa: 0.0000
================================================================================
No existing pretrained weights found

[GPU DEBUG] ========== FUSION STAGE 1 ==========
[GPU DEBUG] SDXL generative augmentation ACTIVE if enabled!
[GPU DEBUG] Expect HIGH GPU usage when SDXL generates images
[GPU DEBUG] =========================================

