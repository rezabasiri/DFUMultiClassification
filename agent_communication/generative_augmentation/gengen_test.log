2026-01-25 18:21:09,945 - INFO - ================================================================================
2026-01-25 18:21:09,945 - INFO - QUICK TEST MODE: 50.0% data, 3 epochs, 64x64 images
2026-01-25 18:21:09,945 - INFO - This is for error checking only - results not production-ready
2026-01-25 18:21:09,945 - INFO - ================================================================================

2026-01-25 18:21:09,946 - INFO - Saved original production_config values
2026-01-25 18:21:09,946 - INFO - Resuming test run - 1/2 tests completed
2026-01-25 18:21:09,946 - INFO - 
Skipping Baseline (no generative augmentation) (already completed)
2026-01-25 18:21:09,946 - INFO - 
================================================================================
2026-01-25 18:21:09,946 - INFO - Starting test 2/2
2026-01-25 18:21:09,946 - INFO - ================================================================================
2026-01-25 18:21:09,946 - INFO - 
================================================================================
2026-01-25 18:21:09,946 - INFO - TEST: With generative augmentation (depth_rgb)
2026-01-25 18:21:09,946 - INFO - ================================================================================
2026-01-25 18:21:09,947 - INFO - Deleted cached dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 18:21:09,947 - INFO - Deleted cached outliers: outliers_depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 18:21:09,948 - INFO - Config updated: USE_GENERATIVE_AUGMENTATION=True
2026-01-25 18:21:09,948 - INFO - Modalities: metadata, depth_rgb, depth_map, thermal_map
2026-01-25 18:21:09,948 - INFO - Running: /venv/multimodal/bin/python src/main.py --data_percentage 50.0 --resume_mode fresh --device-mode multi

COMMAND: /venv/multimodal/bin/python src/main.py --data_percentage 50.0 --resume_mode fresh --device-mode multi

2026-01-25 18:21:10.377811: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2026-01-25 18:21:10.377857: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2026-01-25 18:21:10.378471: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered

================================================================================
DEVICE CONFIGURATION (mode: multi)
================================================================================

Detected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 1: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 2: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 3: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 4: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)

Selected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 1: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 2: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 3: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 4: NVIDIA GeForce RTX 4090 (24.0GB)
Enabled memory growth for 5 GPU(s)

Using MirroredStrategy (5 GPUs) with NCCL
  Compute capability 8.9 detected (native NCCL support)
  (Using NCCL for fastest multi-GPU communication)
  Effective batch size: 5Ã— global batch size
================================================================================


Batch size per replica: 51 (global batch size: 256, replicas: 5)

================================================================================
DFU MULTIMODAL CLASSIFICATION - PRODUCTION PIPELINE
================================================================================
Mode: search
Resume mode: fresh
Data percentage: 50.0%
Verbosity: 1 (NORMAL)
Device: GPUs [0, 1, 2, 3, 4] (multi-GPU mode, MirroredStrategy)
  Replicas: 5Ã— batch size distribution
Cross-validation: 3-fold CV (patient-level)

Configuration loaded from: src/utils/production_config.py
Image size: 64x64
Batch size: 256
  Per-GPU batch: 51 (256 / 5 GPUs)
Max epochs: 3 (with early stopping)
Modality search mode: custom
Will test 1 custom combinations
================================================================================


ðŸ§¹ FRESH START MODE: Deleting all checkpoints...
================================================================================

Cleanup Statistics:
  Models: 2 files deleted
  Csv Results: 1 files deleted
  Tf Cache: 4 files deleted
================================================================================


Data Cleaning Configuration (from production_config.py):
  Outlier removal: True
  Outlier contamination: 15%
  Outlier batch size: 32
  Misclassification tracking: none

================================================================================
OUTLIER DETECTION AND REMOVAL (COMBINATION-SPECIFIC)
================================================================================
Contamination rate: 15%
Processing 1 modality combination(s)

[1/1] depth_map_depth_rgb_metadata_thermal_map
Detecting outliers for combination: depth_map_depth_rgb_metadata_thermal_map (contamination=15%)...
  Total outliers: 417/2774 (15.0%)
  Cleaned dataset: 2357 samples
  Saved cleaned dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
Applying cleaned dataset for depth_map_depth_rgb_metadata_thermal_map (15% outlier removal)...
  Filtered: 2774 samples
  Applied cleaned dataset to: best_matching.csv
  âœ“ Applied for depth_map_depth_rgb_metadata_thermal_map: 2357 samples

================================================================================


================================================================================
MODALITY SEARCH MODE: CUSTOM (1 combinations)
================================================================================
Testing only specified combinations from production_config.py
Total combinations to test: 1
Cross-validation mode: 3-fold CV
Iterations per combination: 3
Total training sessions: 3
Results will be saved to: /workspace/DFUMultiClassification/results/csv/modality_combination_results.csv
================================================================================


Testing modalities: metadata, depth_rgb, depth_map, thermal_map
Number of samples for each selected modality:
  depth_rgb: 2774
  depth_bb: 2774
  depth_map: 2774
  thermal_map: 2774
  thermal_bb: 2774
  metadata: 2774
Using 50.0% of the data: 1387 samples

================================================================================
MULTI-GPU TRAINING: 5 GPUs
Global batch size: 256 (per-GPU: 51)
Strategy: MirroredStrategy
================================================================================


================================================================================
GENERATING 3-FOLD CROSS-VALIDATION SPLITS (PATIENT-LEVEL)
================================================================================

================================================================================
STRATIFIED K-FOLD SPLIT - CLASS DISTRIBUTION CHECK
================================================================================
Class 0: 67 patients
Class 1: 108 patients
Class 2: 24 patients
================================================================================

Fold 1/3: 132 train patients, 67 valid patients
  Train dist: {0: 0.297, 1: 0.601, 2: 0.102}
  Valid dist: {0: 0.256, 1: 0.638, 2: 0.106}
Fold 2/3: 133 train patients, 66 valid patients
  Train dist: {0: 0.281, 1: 0.613, 2: 0.106}
  Valid dist: {0: 0.283, 1: 0.616, 2: 0.100}
Fold 3/3: 133 train patients, 66 valid patients
  Train dist: {0: 0.270, 1: 0.627, 2: 0.103}
  Valid dist: {0: 0.315, 1: 0.580, 2: 0.105}
Generated 3 folds
All data will be validated exactly once across all folds
================================================================================


Fold 1/3
Using pre-computed fold 1 patient split
Using Scikit-learn RandomForestClassifier
Initializing GenerativeAugmentationManager with models from src/models/sdxl_checkpoints
Traceback (most recent call last):
  File "/workspace/DFUMultiClassification/src/main.py", line 2487, in <module>
    main(args.mode, args.data_percentage, args.train_patient_percentage, args.cv_folds)
  File "/workspace/DFUMultiClassification/src/main.py", line 2186, in main
    main_search(data_percentage, train_patient_percentage, cv_folds=cv_folds)
  File "/workspace/DFUMultiClassification/src/main.py", line 1864, in main_search
    cv_results, confusion_matrices, histories = cross_validation_manual_split(
                                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/workspace/DFUMultiClassification/src/training/training_utils.py", line 984, in cross_validation_manual_split
    gen_manager = GenerativeAugmentationManager(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: GenerativeAugmentationManager.__init__() got an unexpected keyword argument 'base_dir'
2026-01-25 18:21:22,545 - INFO -   TypeError: GenerativeAugmentationManager.__init__() got an unexpected keyword argument 'base_dir'
2026-01-25 18:21:23,950 - ERROR - Test FAILED with return code 1
2026-01-25 18:21:23,951 - ERROR - Test failed - stopping
2026-01-25 18:21:23,952 - INFO - Restored original production_config values
2026-01-25 18:21:23,952 - INFO - 
Original configuration restored
2026-01-25 18:21:39,819 - INFO - ================================================================================
2026-01-25 18:21:39,819 - INFO - QUICK TEST MODE: 50.0% data, 3 epochs, 64x64 images
2026-01-25 18:21:39,819 - INFO - This is for error checking only - results not production-ready
2026-01-25 18:21:39,819 - INFO - ================================================================================

2026-01-25 18:21:39,820 - INFO - Saved original production_config values
2026-01-25 18:21:39,820 - INFO - Resuming test run - 1/2 tests completed
2026-01-25 18:21:39,820 - INFO - 
Skipping Baseline (no generative augmentation) (already completed)
2026-01-25 18:21:39,820 - INFO - 
================================================================================
2026-01-25 18:21:39,820 - INFO - Starting test 2/2
2026-01-25 18:21:39,820 - INFO - ================================================================================
2026-01-25 18:21:39,820 - INFO - 
================================================================================
2026-01-25 18:21:39,820 - INFO - TEST: With generative augmentation (depth_rgb)
2026-01-25 18:21:39,820 - INFO - ================================================================================
2026-01-25 18:21:39,821 - INFO - Deleted cached dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 18:21:39,821 - INFO - Deleted cached outliers: outliers_depth_map_depth_rgb_metadata_thermal_map_15pct.csv
2026-01-25 18:21:39,822 - INFO - Config updated: USE_GENERATIVE_AUGMENTATION=True
2026-01-25 18:21:39,822 - INFO - Modalities: metadata, depth_rgb, depth_map, thermal_map
2026-01-25 18:21:39,822 - INFO - Running: /venv/multimodal/bin/python src/main.py --data_percentage 50.0 --resume_mode fresh --device-mode multi

COMMAND: /venv/multimodal/bin/python src/main.py --data_percentage 50.0 --resume_mode fresh --device-mode multi

2026-01-25 18:21:40.249872: E external/local_xla/xla/stream_executor/cuda/cuda_dnn.cc:9261] Unable to register cuDNN factory: Attempting to register factory for plugin cuDNN when one has already been registered
2026-01-25 18:21:40.249911: E external/local_xla/xla/stream_executor/cuda/cuda_fft.cc:607] Unable to register cuFFT factory: Attempting to register factory for plugin cuFFT when one has already been registered
2026-01-25 18:21:40.250603: E external/local_xla/xla/stream_executor/cuda/cuda_blas.cc:1515] Unable to register cuBLAS factory: Attempting to register factory for plugin cuBLAS when one has already been registered

================================================================================
DEVICE CONFIGURATION (mode: multi)
================================================================================

Detected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 1: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 2: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 3: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)
  GPU 4: NVIDIA GeForce RTX 4090 - 24.0GB (compute 8.9)

Selected 5 GPU(s):
  GPU 0: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 1: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 2: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 3: NVIDIA GeForce RTX 4090 (24.0GB)
  GPU 4: NVIDIA GeForce RTX 4090 (24.0GB)
Enabled memory growth for 5 GPU(s)

Using MirroredStrategy (5 GPUs) with NCCL
  Compute capability 8.9 detected (native NCCL support)
  (Using NCCL for fastest multi-GPU communication)
  Effective batch size: 5Ã— global batch size
================================================================================


Batch size per replica: 51 (global batch size: 256, replicas: 5)

================================================================================
DFU MULTIMODAL CLASSIFICATION - PRODUCTION PIPELINE
================================================================================
Mode: search
Resume mode: fresh
Data percentage: 50.0%
Verbosity: 1 (NORMAL)
Device: GPUs [0, 1, 2, 3, 4] (multi-GPU mode, MirroredStrategy)
  Replicas: 5Ã— batch size distribution
Cross-validation: 3-fold CV (patient-level)

Configuration loaded from: src/utils/production_config.py
Image size: 64x64
Batch size: 256
  Per-GPU batch: 51 (256 / 5 GPUs)
Max epochs: 3 (with early stopping)
Modality search mode: custom
Will test 1 custom combinations
================================================================================


ðŸ§¹ FRESH START MODE: Deleting all checkpoints...
================================================================================

Cleanup Statistics:
  Csv Results: 1 files deleted
================================================================================


Data Cleaning Configuration (from production_config.py):
  Outlier removal: True
  Outlier contamination: 15%
  Outlier batch size: 32
  Misclassification tracking: none

================================================================================
OUTLIER DETECTION AND REMOVAL (COMBINATION-SPECIFIC)
================================================================================
Contamination rate: 15%
Processing 1 modality combination(s)

[1/1] depth_map_depth_rgb_metadata_thermal_map
Detecting outliers for combination: depth_map_depth_rgb_metadata_thermal_map (contamination=15%)...
  Total outliers: 417/2774 (15.0%)
  Cleaned dataset: 2357 samples
  Saved cleaned dataset: depth_map_depth_rgb_metadata_thermal_map_15pct.csv
Applying cleaned dataset for depth_map_depth_rgb_metadata_thermal_map (15% outlier removal)...
  Filtered: 2774 samples
  Applied cleaned dataset to: best_matching.csv
  âœ“ Applied for depth_map_depth_rgb_metadata_thermal_map: 2357 samples

================================================================================


================================================================================
MODALITY SEARCH MODE: CUSTOM (1 combinations)
================================================================================
Testing only specified combinations from production_config.py
Total combinations to test: 1
Cross-validation mode: 3-fold CV
Iterations per combination: 3
Total training sessions: 3
Results will be saved to: /workspace/DFUMultiClassification/results/csv/modality_combination_results.csv
================================================================================


Testing modalities: metadata, depth_rgb, depth_map, thermal_map
Number of samples for each selected modality:
  depth_rgb: 2774
  depth_bb: 2774
  depth_map: 2774
  thermal_map: 2774
  thermal_bb: 2774
  metadata: 2774
Using 50.0% of the data: 1387 samples

================================================================================
MULTI-GPU TRAINING: 5 GPUs
Global batch size: 256 (per-GPU: 51)
Strategy: MirroredStrategy
================================================================================


================================================================================
GENERATING 3-FOLD CROSS-VALIDATION SPLITS (PATIENT-LEVEL)
================================================================================

================================================================================
STRATIFIED K-FOLD SPLIT - CLASS DISTRIBUTION CHECK
================================================================================
Class 0: 67 patients
Class 1: 108 patients
Class 2: 24 patients
================================================================================

Fold 1/3: 132 train patients, 67 valid patients
  Train dist: {0: 0.297, 1: 0.601, 2: 0.102}
  Valid dist: {0: 0.256, 1: 0.638, 2: 0.106}
Fold 2/3: 133 train patients, 66 valid patients
  Train dist: {0: 0.281, 1: 0.613, 2: 0.106}
  Valid dist: {0: 0.283, 1: 0.616, 2: 0.100}
Fold 3/3: 133 train patients, 66 valid patients
  Train dist: {0: 0.270, 1: 0.627, 2: 0.103}
  Valid dist: {0: 0.315, 1: 0.580, 2: 0.105}
Generated 3 folds
All data will be validated exactly once across all folds
================================================================================


Fold 1/3
Using pre-computed fold 1 patient split
Using Scikit-learn RandomForestClassifier
Initializing GenerativeAugmentationManager with models from src/models/sdxl_checkpoints
Traceback (most recent call last):
  File "/workspace/DFUMultiClassification/src/main.py", line 2487, in <module>
    main(args.mode, args.data_percentage, args.train_patient_percentage, args.cv_folds)
  File "/workspace/DFUMultiClassification/src/main.py", line 2186, in main
    main_search(data_percentage, train_patient_percentage, cv_folds=cv_folds)
  File "/workspace/DFUMultiClassification/src/main.py", line 1864, in main_search
    cv_results, confusion_matrices, histories = cross_validation_manual_split(
                                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/workspace/DFUMultiClassification/src/training/training_utils.py", line 984, in cross_validation_manual_split
    gen_manager = GenerativeAugmentationManager(
                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
TypeError: GenerativeAugmentationManager.__init__() got an unexpected keyword argument 'base_dir'
2026-01-25 18:21:52,515 - INFO -   TypeError: GenerativeAugmentationManager.__init__() got an unexpected keyword argument 'base_dir'
2026-01-25 18:21:53,963 - ERROR - Test FAILED with return code 1
2026-01-25 18:21:53,963 - ERROR - Test failed - stopping
2026-01-25 18:21:53,965 - INFO - Restored original production_config values
2026-01-25 18:21:53,965 - INFO - 
Original configuration restored
