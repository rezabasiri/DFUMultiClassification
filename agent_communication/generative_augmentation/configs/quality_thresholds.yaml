# Quality Filtering Thresholds for Inference
# Used during training data augmentation to filter low-quality generated images
# Only images passing these thresholds will be used for training

# ==============================================================================
# Global Settings
# ==============================================================================
filtering:
  # Enable quality filtering (if false, all generated images are used)
  enabled: true

  # Rejection strategy when image fails quality check
  # "reject" = don't use the image at all
  # "fallback_to_real" = use original real image instead
  strategy: "reject"

  # Minimum number of metrics that must pass (out of enabled metrics)
  # Example: If 3 metrics enabled and min_passing=2, image passes if 2/3 metrics pass
  min_passing_metrics: 2

  # Log rejection statistics
  log_rejections: true
  log_every_n_rejections: 100

# ==============================================================================
# FID (Fr√©chet Inception Distance)
# ==============================================================================
# Measures distribution similarity between generated and real images
# Lower is better
# Typical ranges:
#   < 10  = Excellent (nearly indistinguishable)
#   < 30  = Very Good (high quality)
#   < 50  = Good (acceptable quality)
#   < 100 = Fair (noticeable differences)
#   > 100 = Poor (significant quality issues)

fid:
  enabled: true

  # Maximum allowed FID score per image (compared to reference set)
  # Note: FID is typically computed over sets, but we approximate per-image FID
  max_threshold: 60.0

  # Size of reference set for comparison (random sample from real images)
  reference_set_size: 50

# ==============================================================================
# SSIM (Structural Similarity Index)
# ==============================================================================
# Measures structural similarity between generated and real images
# Higher is better (range: -1 to 1, typically 0 to 1)
# Typical ranges:
#   > 0.90 = Excellent (very similar structure)
#   > 0.80 = Very Good
#   > 0.70 = Good (acceptable similarity)
#   > 0.60 = Fair
#   < 0.60 = Poor (significant structural differences)

ssim:
  enabled: true

  # Minimum allowed SSIM score (compared to most similar real image)
  min_threshold: 0.70

  # Number of real images to compare against (uses maximum SSIM)
  num_comparisons: 10

  # Use multichannel SSIM (vs grayscale)
  multichannel: true

# ==============================================================================
# LPIPS (Learned Perceptual Image Patch Similarity)
# ==============================================================================
# Measures perceptual similarity using deep features
# Lower is better (range: 0 to ~1)
# Typical ranges:
#   < 0.10 = Excellent (perceptually very similar)
#   < 0.20 = Very Good
#   < 0.30 = Good (acceptable perceptual quality)
#   < 0.40 = Fair
#   > 0.40 = Poor (perceptually different)

lpips:
  enabled: true

  # Maximum allowed LPIPS score (compared to most similar real image)
  max_threshold: 0.35

  # Number of real images to compare against (uses minimum LPIPS)
  num_comparisons: 10

  # LPIPS network to use
  network: "alex"  # Options: "alex", "vgg", "squeeze"

# ==============================================================================
# Inception Score (IS)
# ==============================================================================
# Measures both quality and diversity of generated images
# Higher is better (range: 1 to ~100+, but typically 1-10 for specialized domains)
# Typical ranges:
#   > 4.0 = Excellent (for general images)
#   > 3.0 = Very Good
#   > 2.0 = Good (acceptable for medical images)
#   > 1.5 = Fair
#   < 1.5 = Poor

inception_score:
  enabled: false  # Disabled by default (less useful for per-image filtering)

  # Minimum allowed inception score per image
  min_threshold: 1.8

  # Compute over batches rather than individual images
  batch_mode: true
  batch_size: 16

# ==============================================================================
# Custom Heuristics (Optional)
# ==============================================================================
# Additional simple checks that can quickly filter obviously bad images

heuristics:
  # Check for completely black or white images
  check_blank_images:
    enabled: true
    max_black_ratio: 0.95  # Reject if >95% pixels are black
    max_white_ratio: 0.95  # Reject if >95% pixels are white

  # Check for extreme brightness/contrast issues
  check_brightness:
    enabled: true
    min_mean_brightness: 0.05  # Reject if mean brightness < 5%
    max_mean_brightness: 0.95  # Reject if mean brightness > 95%

  # Check for color saturation issues
  check_saturation:
    enabled: true
    min_std_saturation: 0.01  # Reject if no color variation

  # Check for noise/artifacts (using edge detection)
  check_noise:
    enabled: false  # Disabled (computationally expensive)
    max_edge_ratio: 0.8  # Reject if >80% edges (too noisy)

# ==============================================================================
# Phase-Specific Overrides
# ==============================================================================
# Can override thresholds for specific phases if needed

phase_specific:
  # Phase I (Inflammatory) - typically more variation, slightly relaxed thresholds
  I:
    ssim:
      min_threshold: 0.68  # Slightly lower than default 0.70
    lpips:
      max_threshold: 0.38  # Slightly higher than default 0.35

  # Phase R (Remodeling) - minority class, more important, stricter thresholds
  R:
    ssim:
      min_threshold: 0.72  # Slightly higher than default 0.70
    lpips:
      max_threshold: 0.32  # Slightly lower than default 0.35

# ==============================================================================
# Adaptive Thresholds (Advanced)
# ==============================================================================
# Automatically adjust thresholds based on rejection rate

adaptive:
  # Enable adaptive threshold adjustment
  enabled: false

  # Target rejection rate (if rejection rate deviates, adjust thresholds)
  target_rejection_rate: 0.15  # Aim for 15% rejection

  # Adjustment rate (how quickly to adapt)
  adjustment_rate: 0.05  # Adjust thresholds by 5% per epoch

  # Adjustment interval
  adjust_every_n_epochs: 5

# ==============================================================================
# Caching (Performance Optimization)
# ==============================================================================
# Cache quality metrics for reference images to avoid recomputation

caching:
  # Enable caching of reference image features
  enabled: true

  # Cache directory
  cache_dir: "agent_communication/generative_augmentation/.cache/quality_metrics"

  # Invalidate cache if reference images change
  check_reference_hash: true

# ==============================================================================
# Reporting
# ==============================================================================
reporting:
  # Save detailed rejection reports
  save_rejection_report: true
  report_dir: "agent_communication/generative_augmentation/reports/quality_filtering"

  # Include rejected images in report (for debugging)
  save_rejected_images: true
  max_rejected_images_to_save: 50

  # Generate quality distribution plots
  generate_plots: true
