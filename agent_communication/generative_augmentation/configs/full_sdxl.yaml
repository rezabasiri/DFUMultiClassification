# SDXL 1.0 Base - 512x512 (Full Fine-tuning)
model:
  base_model: "stabilityai/stable-diffusion-xl-base-1.0"
  resolution: 512  # Ideal resolution for SDXL - testing with DeepSpeed ZeRO-2
  training_method: "full"  # Full fine-tuning for maximum quality (like successful SD 1.5 approach)

lora:
  rank: 128  # MAXIMUM rank for best medical domain adaptation
  alpha: 256  # 2x rank
  dropout: 0.05  # Reduced dropout for maximum capacity
  # CRITICAL: Added feed-forward modules to learn wound-specific textures
  # Attention modules (to_q, to_k, to_v) = spatial relationships
  # Feed-forward modules (ff.net) = visual features/textures
  target_modules: ["to_q", "to_k", "to_v", "to_out.0", "ff.net.0.proj", "ff.net.2"]
  bias: "none"

data:
  data_root: "/workspace/DFUMultiClassification/data/diffusion"  # New organized data
  bbox_file: "/workspace/DFUMultiClassification/data/raw/bounding_box_depth.csv"  # Bbox annotations
  modality: "rgb"
  phase: "all"  # Use all phases (I=860, P=1678, R=322) = 2860 images total
  data_percentage: 30  # Use 100% of images from each phase
  # Balanced sampling - weights computed dynamically from actual class counts
  # "auto" = compute weights inversely proportional to class frequency
  class_weights: "auto"
  train_val_split: 0.90  # 90% train, 10% validation
  split_seed: 42
  augmentation:
    enabled: true
    horizontal_flip: true
    vertical_flip: true
    rotation_degrees: 0  # No rotation - avoid black corners, wounds have orientation
    scale_range: [0.9, 1.1]  # Slight scaling to preserve wound size realism
    color_jitter:
      brightness: 0.05  # Reduced - wounds have class-specific colors
      contrast: 0.05    # Reduced - preserve tissue appearance
      saturation: 0.05  # Reduced - wound phases have distinct coloration
      hue: 0.01         # Minimal - critical for phase identification
    bbox_crop_prob: 1.0  # 100% bbox crop - only show wound area, exclude images without bbox
    bbox_margin_range: [0.05, 0.15]  # Add 5-15% random margin around bbox

training:
  batch_size_per_gpu: 2  # Moderate batch size
  gradient_accumulation_steps: 12  # Smooths updates for full fine-tune, reduces catastrophic drift
  learning_rate: 3.0e-6  # Lower LR for full fine-tune SDXL to prevent overfit
  lr_scheduler: "cosine"  # Cosine annealing
  lr_warmup_ratio: 0.0008  # 0.2% of total steps (~154 steps) - reach full LR within epoch 1
  lr_num_cycles: 1
  optimizer: "adamw"
  adam_beta1: 0.9
  adam_beta2: 0.999
  adam_weight_decay: 0.01
  adam_epsilon: 1.0e-8
  max_grad_norm: 0.5  # Tighter gradient clipping helps bf16 stability
  max_epochs: 200  # Reduced from 300 - full fine-tune on 2.8k images needs fewer epochs
  prompt_dropout: 0.20  # CFG training - expose model to unconditional conditioning
  early_stopping:
    enabled: true
    patience: 20  # Shortened for fewer epochs
    min_delta: 0.001  # Tighter threshold
    monitor: "val_loss"  # Metric to monitor for early stopping
    mode: "min"  # "min" for loss, "max" for accuracy

prompts:
  enabled: true
  # Hybrid approach: hard token prefix + descriptive text for semantic grounding
  # PHASE_X forces distinction, descriptive text helps SDXL understand what to generate
  phase_prompts:
    I: "PHASE_I, diabetic foot ulcer, inflammatory phase wound"
    P: "PHASE_P, diabetic foot ulcer, proliferative phase wound"
    R: "PHASE_R, diabetic foot ulcer, remodeling phase wound"
  positive: "diabetic foot ulcer"
  negative: >
    blurry, out of focus, low quality, jpeg artifacts,
    cartoon, illustration, painting, anime,
    text, watermark, logo

quality:
  perceptual_loss:
    enabled: true  # test # DISABLED wroked before - VGG trained on ImageNet pushes toward "natural" style, not medical realism
    weight: 0.001
    vgg_layer: 16
  ema:
    enabled: true
    decay: 0.999  # Standard EMA decay for stability
    use_ema_weights_for_inference: true #test  # DISABLED wroked before - use main model to see actual learning, not EMA
  guidance_scale: 4.0  # REDUCED from 12.0 - lower guidance = less prompt reliance, more training data learning
  inference_steps_training: 50
  inference_steps_production: 50

checkpointing:
  output_dir: "agent_communication/generative_augmentation/checkpoints/full_sdxl"
  save_every_n_epochs: 5  # Save checkpoint every 5 epochs
  keep_last_n_checkpoints: 2  # Keep only 2 checkpoints: best + last
  save_best_only: false
  resume_from_checkpoint: null
  save_optimizer_state: true

metrics:
  compute_every_n_epochs: 5  # FID every 5 epochs
  num_samples_for_metrics: 50
  generation_batch_size: 10  # Generate images in batches to avoid OOM at 512x512
  fid:
    enabled: true
    target_threshold: 50.0
  ssim:
    enabled: true
    target_threshold: 0.70
  lpips:
    enabled: true
    target_threshold: 0.30
    network: "alex"
  inception_score:
    enabled: true
    target_threshold: 2.0

logging:
  logging_dir: "agent_communication/generative_augmentation/reports/full_sdxl_logs"
  log_every_n_steps: 50 
  save_samples_every_n_epochs: 5  # Save samples every 5 epochs
  num_samples_to_save: 16
  use_tensorboard: true
  use_wandb: false

hardware:
  multi_gpu: true
  num_gpus: 5
  mixed_precision: "bf16"  # BF16 worked before with lower LR (2e-6) to prevent NaN
  gradient_checkpointing: true
  use_xformers: false  # SDXL attention dim incompatible
  enable_cpu_offload: true  # Offload optimizer states to CPU for additional memory savings
  num_workers: 4  # Reduced from 8 to avoid potential deadlock
  pin_memory: true

reproducibility:
  seed: 42
  deterministic: false

validation:
  # NOTE: val_loss is computed every epoch for early stopping to work properly
  # validate_every_n_epochs is kept for backward compatibility but no longer used
  generate_samples: true  # Enable sample generation
  num_validation_samples: 4
  compare_to_real: true
  num_real_samples_for_comparison: 50
  save_reference_images: true  # Save reference images once at start
  num_reference_images_per_phase: 16  # Randomly sample per phase
  reference_images_seed: 42  # For reproducible sampling
