# SDXL 1.0 Base - 128x128 (half-Full Fine-tuning)
model:
  base_model: "stabilityai/stable-diffusion-xl-base-1.0"
  resolution: 128 #change to 512 for full resolution
  training_method: "full"  # Full fine-tuning for maximum quality (like successful SD 1.5 approach)

lora:
  rank: 128  # MAXIMUM rank for best medical domain adaptation
  alpha: 256  # 2x rank
  dropout: 0.05  # Reduced dropout for maximum capacity
  # CRITICAL: Added feed-forward modules to learn wound-specific textures
  # Attention modules (to_q, to_k, to_v) = spatial relationships
  # Feed-forward modules (ff.net) = visual features/textures
  target_modules: ["to_q", "to_k", "to_v", "to_out.0", "ff.net.0.proj", "ff.net.2"]
  bias: "none"

data:
  data_root: "/workspace/DFUMultiClassification/data/diffusion"  # New organized data
  bbox_file: "/workspace/DFUMultiClassification/data/raw/bounding_box_depth.csv"  # Bbox annotations
  modality: "rgb"
  phase: "all"  # Use all phases (I=860, P=1678, R=322) = 2860 images total
  data_percentage: 100  # Use 100% of images from each phase (balanced sampling)
  train_val_split: 0.90  # 90% train, 10% validation
  split_seed: 42
  augmentation:
    enabled: true
    horizontal_flip: true
    vertical_flip: true
    rotation_degrees: 15
    color_jitter:
      brightness: 0.05  # Reduced - wounds have class-specific colors
      contrast: 0.05    # Reduced - preserve tissue appearance
      saturation: 0.05  # Reduced - wound phases have distinct coloration
      hue: 0.01         # Minimal - critical for phase identification
    bbox_crop_prob: 1.0  # 100% bbox crop - only show wound area, exclude images without bbox
    bbox_margin_range: [0.05, 0.15]  # Add 5-15% random margin around bbox

training:
  batch_size_per_gpu: 24  # Reduced for full fine-tuning (more memory intensive)
  gradient_accumulation_steps: 4 
  learning_rate: 5.0e-6  # Lower for full fine-tuning (typical: 1e-6 to 1e-5)
  lr_scheduler: "cosine"  # Cosine annealing
  lr_warmup_steps: 500  # Gradual warmup for stability
  lr_num_cycles: 1
  optimizer: "adamw"
  adam_beta1: 0.9
  adam_beta2: 0.999
  adam_weight_decay: 0.01
  adam_epsilon: 1.0e-8
  max_grad_norm: 1.0
  max_epochs: 300  # High limit, early stopping will end training when converged
  early_stopping:
    enabled: true
    patience: 30  # Stop if no improvement for 30 epochs
    min_delta: 0.01
    monitor: "val_loss"  # Metric to monitor for early stopping
    mode: "min"  # "min" for loss, "max" for accuracy

prompts:
  enabled: true
  # Phase-specific prompts for multi-phase training - WOUND-ONLY FOCUS
  # Model learns to associate each phase with its visual characteristics
  phase_prompts:
    I: >
      Close-up clinical photograph of diabetic foot ulcer wound in inflammatory phase,
      acute open wound with redness erythema and swelling edema around wound margins,
      early wound response showing tissue inflammation and wound debridement stage,
      detailed wound bed texture with surrounding inflamed tissue,
      professional medical documentation, high resolution, sharp focus, clinical lighting
    P: >
      Close-up clinical photograph of diabetic foot ulcer wound in proliferative phase,
      active granulation tissue formation with pink red moist wound bed,
      new tissue growth and collagen deposition showing visible angiogenesis,
      detailed wound healing texture with tissue proliferation,
      professional medical documentation, high resolution, sharp focus, clinical lighting
    R: >
      Close-up clinical photograph of diabetic foot ulcer wound in remodeling phase,
      mature scar tissue with wound contraction and epithelialization,
      late stage healing showing tissue maturation and skin regrowth,
      detailed wound closure with remodeled tissue texture,
      professional medical documentation, high resolution, sharp focus, clinical lighting
  # Fallback positive prompt (used if phase_prompts not available)
  positive: >
    Close-up clinical photograph of diabetic foot ulcer wound,
    detailed wound bed and surrounding tissue texture,
    professional medical documentation, high resolution, sharp focus,
    clinical lighting
  negative: >
    blurry, out of focus, low quality, jpeg artifacts, noise, grainy,
    cartoon, illustration, drawing, painting, artistic, stylized, anime,
    artificial, fake, CGI, 3D render, digital art, unrealistic,
    smooth plastic skin, mannequin, doll, toy,
    healthy unblemished skin, no wound, perfect skin,
    text, watermark, logo, signature, border, frame,
    feet, toes, body parts, limbs, person, full body, distant view,
    extreme wide shot, background clutter, unrelated objects

quality:
  perceptual_loss:
    enabled: true
    weight: 0.1  # Lower for full fine-tuning (diffusion loss is primary)
    vgg_layer: 16
  ema:
    enabled: true
    decay: 0.9999
    use_ema_weights_for_inference: true
  guidance_scale: 12.0  # Increased from 7.5 for stronger prompt adherence in medical domain
  inference_steps_training: 50
  inference_steps_production: 50

checkpointing:
  output_dir: "agent_communication/generative_augmentation/checkpoints/full_sdxl"
  save_every_n_epochs: 10  # Save checkpoint every 10 epochs
  keep_last_n_checkpoints: 2  # Keep only 2 checkpoints: best + last
  save_best_only: false
  resume_from_checkpoint: null
  save_optimizer_state: true

metrics:
  compute_every_n_epochs: 10  # FID every 10 epochs
  num_samples_for_metrics: 50
  generation_batch_size: 2  # Generate images in batches to avoid OOM at 512x512
  fid:
    enabled: true
    target_threshold: 50.0
  ssim:
    enabled: true
    target_threshold: 0.70
  lpips:
    enabled: true
    target_threshold: 0.30
    network: "alex"
  inception_score:
    enabled: true
    target_threshold: 2.0

logging:
  logging_dir: "agent_communication/generative_augmentation/reports/full_sdxl_logs"
  log_every_n_steps: 100  # Log every 100 steps
  save_samples_every_n_epochs: 10  # Save samples every 10 epochs
  num_samples_to_save: 16
  use_tensorboard: true
  use_wandb: false

hardware:
  multi_gpu: true
  num_gpus: 5
  mixed_precision: "no"  # fp16 causes errors
  gradient_checkpointing: true
  use_xformers: false  # SDXL attention dim incompatible
  enable_cpu_offload: false
  num_workers: 4  # Reduced from 8 to avoid potential deadlock
  pin_memory: true

reproducibility:
  seed: 42
  deterministic: false

validation:
  # NOTE: val_loss is computed every epoch for early stopping to work properly
  # validate_every_n_epochs is kept for backward compatibility but no longer used
  generate_samples: true  # Enable sample generation
  num_validation_samples: 4
  compare_to_real: true
  num_real_samples_for_comparison: 50
  save_reference_images: true  # Save reference images once at start
  num_reference_images_per_phase: 16  # Randomly sample per phase
  reference_images_seed: 42  # For reproducible sampling
