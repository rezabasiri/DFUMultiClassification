# SDXL 1.0 Base - 256x256 (half-Full run with 100% of images)
model:
  base_model: "stabilityai/stable-diffusion-xl-base-1.0"
  resolution: 256 #change to 512 for full resolution
  training_method: "lora"

lora:
  rank: 128  # MAXIMUM rank for best medical domain adaptation
  alpha: 256  # 2x rank
  dropout: 0.05  # Reduced dropout for maximum capacity
  # CRITICAL: Added feed-forward modules to learn wound-specific textures
  # Attention modules (to_q, to_k, to_v) = spatial relationships
  # Feed-forward modules (ff.net) = visual features/textures
  target_modules: ["to_q", "to_k", "to_v", "to_out.0", "ff.net.0.proj", "ff.net.2"]
  bias: "none"

data:
  data_root: "/workspace/DFUMultiClassification/data/diffusion"  # New organized data
  modality: "rgb"
  phase: "all"  # Use all phases (I=860, P=1678, R=322) = 2860 images total
  data_percentage: 100  # Use 100% of images from each phase (balanced sampling)
  train_val_split: 0.90  # 90% train, 10% validation
  split_seed: 42
  augmentation:
    enabled: true
    horizontal_flip: true
    vertical_flip: true
    rotation_degrees: 15
    color_jitter:
      brightness: 0.2
      contrast: 0.2
      saturation: 0.2
      hue: 0.05

training:
  batch_size_per_gpu: 4  # Increased for better GPU utilization (~20GB/24GB)
  gradient_accumulation_steps: 2  # Effective batch size = 4 * 2 * 2 GPUs = 16
  learning_rate: 1.0e-4  # Higher for LoRA
  lr_scheduler: "cosine"  # Cosine annealing
  lr_warmup_steps: 500  # Increased for rank-128 stability
  lr_num_cycles: 1
  optimizer: "adamw"
  adam_beta1: 0.9
  adam_beta2: 0.999
  adam_weight_decay: 0.01
  adam_epsilon: 1.0e-8
  max_grad_norm: 1.0
  max_epochs: 200  # 2860 images * 200 epochs / 16 batch = 35,750 steps
  early_stopping:
    enabled: true
    patience: 30  # Stop if no improvement for 30 epochs
    min_delta: 0.01
    monitor: "val_loss"  # Metric to monitor for early stopping
    mode: "min"  # "min" for loss, "max" for accuracy

prompts:
  enabled: true
  # Phase-specific prompts for multi-phase training
  # Model learns to associate each phase with its visual characteristics
  phase_prompts:
    I: >
      Realistic clinical photograph of human foot with diabetic foot ulcer in inflammatory phase,
      acute open wound showing redness erythema and swelling edema around wound margins,
      early wound response with tissue inflammation, wound debridement stage,
      real patient foot anatomy with toes and skin texture visible,
      professional medical documentation, high resolution, sharp focus, clinical lighting
    P: >
      Realistic clinical photograph of human foot with diabetic foot ulcer in proliferative phase,
      active granulation tissue formation with pink red moist wound bed,
      new tissue growth and collagen deposition, visible angiogenesis,
      healing wound on real patient foot with natural skin and anatomical features,
      professional medical documentation, high resolution, sharp focus, clinical lighting
    R: >
      Realistic clinical photograph of human foot with diabetic foot ulcer in remodeling phase,
      mature scar tissue with wound contraction and epithelialization,
      late stage healing with tissue maturation and skin regrowth,
      healed or healing wound on real patient foot with natural anatomy,
      professional medical documentation, high resolution, sharp focus, clinical lighting
  # Fallback positive prompt (used if phase_prompts not available)
  positive: >
    Realistic clinical photograph of human foot with diabetic foot ulcer wound,
    real patient anatomy with visible toes skin texture and natural foot features,
    professional medical documentation, high resolution, sharp focus,
    detailed wound and tissue texture, clinical lighting
  negative: >
    blurry, out of focus, low quality, jpeg artifacts, noise, grainy,
    cartoon, illustration, drawing, painting, artistic, stylized, anime,
    artificial, fake, CGI, 3D render, digital art, unrealistic,
    smooth plastic skin, mannequin, doll, toy,
    healthy unblemished skin, no wound, perfect skin,
    text, watermark, logo, signature, border, frame,
    cropped, partial foot, extreme close-up without context

quality:
  perceptual_loss:
    enabled: true
    weight: 0.4  # Balanced weight - not too dominant over diffusion loss
    vgg_layer: 16
  ema:
    enabled: true
    decay: 0.9999
    use_ema_weights_for_inference: true
  guidance_scale: 12.0  # Increased from 7.5 for stronger prompt adherence in medical domain
  inference_steps_training: 50
  inference_steps_production: 50

checkpointing:
  output_dir: "agent_communication/generative_augmentation/checkpoints/full_sdxl"
  save_every_n_epochs: 10  # Save checkpoint every 10 epochs
  keep_last_n_checkpoints: 2  # Keep only 2 checkpoints: best + last
  save_best_only: false
  resume_from_checkpoint: null
  save_optimizer_state: true

metrics:
  compute_every_n_epochs: 10  # FID every 10 epochs
  num_samples_for_metrics: 50
  generation_batch_size: 2  # Generate images in batches to avoid OOM at 512x512
  fid:
    enabled: true
    target_threshold: 50.0
  ssim:
    enabled: true
    target_threshold: 0.70
  lpips:
    enabled: true
    target_threshold: 0.30
    network: "alex"
  inception_score:
    enabled: true
    target_threshold: 2.0

logging:
  logging_dir: "agent_communication/generative_augmentation/reports/full_sdxl_logs"
  log_every_n_steps: 100  # Log every 100 steps
  save_samples_every_n_epochs: 10  # Save samples every 10 epochs
  num_samples_to_save: 16
  use_tensorboard: true
  use_wandb: false

hardware:
  multi_gpu: true
  num_gpus: 2
  mixed_precision: "no"  # fp16 causes errors
  gradient_checkpointing: true
  use_xformers: false  # SDXL attention dim incompatible
  enable_cpu_offload: false
  num_workers: 4  # Reduced from 8 to avoid potential deadlock
  pin_memory: true

reproducibility:
  seed: 42
  deterministic: false

validation:
  # NOTE: val_loss is computed every epoch for early stopping to work properly
  # validate_every_n_epochs is kept for backward compatibility but no longer used
  generate_samples: true  # Enable sample generation
  num_validation_samples: 4
  compare_to_real: true
  num_real_samples_for_comparison: 50
