================================================================================
COMPREHENSIVE VALIDATION TESTS - RF Quality Preservation Fix
================================================================================

COPY AND PASTE THIS TO LOCAL AGENT FOR EXECUTION

CRITICAL FIX IMPLEMENTED:
- Removed Dense layer that was re-learning from RF probabilities
- Metadata-only: Uses RF predictions directly (Activation only)
- Multi-modal: Preserves RF quality, combines with image predictions
- Image-only: Original architecture preserved (no regression)

================================================================================
PRE-TEST SETUP
================================================================================

1. Pull latest changes:
cd /Users/rezabasiri/Documents/Githubs/DFUMultiClassification
git pull origin claude/run-dataset-polishing-X1NHe

2. Verify commit:
git log --oneline -1
# Should show: "fix: Preserve RF quality in all modality combinations"

3. Set Python environment:
export PYTHON_CMD="/Users/rezabasiri/env/multimodal/bin/python"

================================================================================
TEST 1: METADATA-ONLY (PRIMARY - MUST PASS)
================================================================================

OBJECTIVE: Verify RF predictions used directly without Dense layer degradation

CONFIGURATION:
File: src/utils/production_config.py
Set: included_modalities = [('metadata',),]

COMMAND:
cd /Users/rezabasiri/Documents/Githubs/DFUMultiClassification
$PYTHON_CMD src/main.py --mode search --cv_folds 5 --verbosity 2 --resume_mode fresh

EXPECTED OUTPUT INDICATORS:
✅ "Model: Metadata-only - using RF predictions directly (no Dense layer)"
✅ Feature selection: 54 → 40 features
✅ Top 5 features: Valid ML features (Onset, BMI, Weight, Temperatures, etc.)
✅ NO "Epoch 1/300" with high loss values
✅ Model should train quickly (RF is pre-trained)

EXPECTED PERFORMANCE:
✅ Kappa: 0.19-0.22 (target: 0.20 ± 0.05)
✅ Accuracy: 50-55%
✅ F1 Macro: 0.40-0.48
✅ All folds: Kappa > 0.10 (no negative or very low values)
✅ Std deviation: ≤ 0.08

SUCCESS CRITERIA:
PRIMARY: Kappa ≥ 0.19 (83% improvement from 0.109)
SECONDARY: Message confirms "no Dense layer"
TERTIARY: Consistent across all 5 folds

REPORT FORMAT:
---
TEST 1: METADATA-ONLY
Status: [PASS/FAIL]
Kappa: [value] ± [std]
Accuracy: [value]%
Model message seen: [Yes/No] - "using RF predictions directly"
Improvement vs v4 (0.109): [delta] ([percentage]%)

Per-fold Kappa:
  Fold 1: [value]
  Fold 2: [value]
  Fold 3: [value]
  Fold 4: [value]
  Fold 5: [value]

All folds > 0.10: [Yes/No]
Kappa ≥ 0.19: [Yes/No]
---

================================================================================
TEST 2: METADATA + 1 IMAGE (MULTI-MODAL FUSION)
================================================================================

OBJECTIVE: Verify RF quality preserved when fusing with image modality

CONFIGURATION:
File: src/utils/production_config.py
Set: included_modalities = [('metadata', 'depth_rgb'),]

COMMAND:
cd /Users/rezabasiri/Documents/Githubs/DFUMultiClassification
$PYTHON_CMD src/main.py --mode search --cv_folds 3 --verbosity 2 --resume_mode fresh

EXPECTED OUTPUT INDICATORS:
✅ "Model: Metadata + 1 image - preserving RF quality in fusion"
✅ Training proceeds normally (NN training for fusion)
✅ Model architecture includes both metadata and image branches

EXPECTED PERFORMANCE:
✅ Kappa: 0.22-0.28 (better than metadata-only 0.20)
✅ Should exceed metadata-only performance
✅ Should exceed image-only performance

SUCCESS CRITERIA:
PRIMARY: Kappa > 0.20 (benefits from both modalities)
SECONDARY: Message confirms "preserving RF quality"
TERTIARY: Performance better than either modality alone

REPORT FORMAT:
---
TEST 2: METADATA + 1 IMAGE
Status: [PASS/FAIL]
Kappa: [value] ± [std]
Accuracy: [value]%
Model message seen: [Yes/No] - "preserving RF quality in fusion"
Improvement vs metadata-only (0.20): [delta] ([percentage]%)

Per-fold Kappa:
  Fold 1: [value]
  Fold 2: [value]
  Fold 3: [value]

Kappa > 0.20: [Yes/No]
---

================================================================================
TEST 3: IMAGE-ONLY (NO REGRESSION CHECK)
================================================================================

OBJECTIVE: Verify image-only performance not affected (no regression)

CONFIGURATION:
File: src/utils/production_config.py
Set: included_modalities = [('depth_rgb',),]

COMMAND:
cd /Users/rezabasiri/Documents/Githubs/DFUMultiClassification
$PYTHON_CMD src/main.py --mode search --cv_folds 3 --verbosity 2 --resume_mode fresh

EXPECTED OUTPUT INDICATORS:
✅ NO metadata-related messages
✅ Standard NN training (Epoch 1/300...)
✅ Uses original Dense layer architecture (expected behavior)

EXPECTED PERFORMANCE:
✅ Kappa: Similar to previous image-only runs
✅ No degradation from fix

SUCCESS CRITERIA:
PRIMARY: No errors or crashes
SECONDARY: Performance similar to historical baseline
TERTIARY: Architecture unchanged from original

REPORT FORMAT:
---
TEST 3: IMAGE-ONLY
Status: [PASS/FAIL]
Kappa: [value] ± [std]
Accuracy: [value]%
No metadata messages: [Yes/No]
Standard NN training observed: [Yes/No]
No errors: [Yes/No]
---

================================================================================
TEST 4: MODEL ARCHITECTURE INSPECTION (METADATA-ONLY)
================================================================================

OBJECTIVE: Verify NO Dense layer on top of RF probabilities

SCRIPT:
Create file: /Users/rezabasiri/Documents/Githubs/DFUMultiClassification/inspect_model.py

```python
import sys
sys.path.insert(0, '/Users/rezabasiri/Documents/Githubs/DFUMultiClassification')

from src.models.builders import create_multimodal_model
import tensorflow as tf

# Create metadata-only model
input_shapes = {'metadata': (3,)}  # RF produces 3 probabilities
selected_modalities = ['metadata']
class_weights = {0: 1.0, 1: 1.0, 2: 1.0}

model = create_multimodal_model(input_shapes, selected_modalities, class_weights, strategy=None)

print("\n" + "="*80)
print("MODEL ARCHITECTURE - METADATA-ONLY")
print("="*80)
model.summary()

print("\n" + "="*80)
print("LAYER ANALYSIS")
print("="*80)

for i, layer in enumerate(model.layers):
    print(f"Layer {i}: {layer.name} ({layer.__class__.__name__})")
    if hasattr(layer, 'units'):
        print(f"  Units: {layer.units}")
    if hasattr(layer, 'activation'):
        print(f"  Activation: {layer.activation}")

print("\n" + "="*80)
print("CRITICAL CHECK")
print("="*80)

# Count Dense layers
dense_layers = [l for l in model.layers if 'Dense' in l.__class__.__name__]
print(f"Number of Dense layers: {len(dense_layers)}")

# Find output layer
output_layer = model.layers[-1]
print(f"Output layer: {output_layer.name} ({output_layer.__class__.__name__})")

# Check for Dense layer between metadata input and output
has_dense_before_output = False
for layer in model.layers:
    if 'Dense' in layer.__class__.__name__ and layer != output_layer:
        if 'metadata' in layer.name or layer.name == 'output':
            has_dense_before_output = True
            print(f"⚠️  Found Dense layer: {layer.name}")

if not has_dense_before_output and 'Activation' in output_layer.__class__.__name__:
    print("✅ PASS: No Dense layer degrading RF predictions")
    print("✅ Output layer is Activation (softmax) - RF quality preserved!")
elif not has_dense_before_output and 'Dense' not in output_layer.__class__.__name__:
    print("✅ PASS: Output layer is not Dense")
else:
    print("❌ FAIL: Dense layer found that may degrade RF predictions")

print("="*80)
```

COMMAND:
cd /Users/rezabasiri/Documents/Githubs/DFUMultiClassification
$PYTHON_CMD inspect_model.py

EXPECTED OUTPUT:
✅ "Number of Dense layers: 0" OR "Number of Dense layers: 1" (only if it's the final output)
✅ "Output layer: output (Activation)"
✅ "PASS: No Dense layer degrading RF predictions"
✅ "Output layer is Activation (softmax) - RF quality preserved!"

REPORT FORMAT:
---
TEST 4: ARCHITECTURE INSPECTION
Status: [PASS/FAIL]
Dense layers found: [count]
Output layer type: [Activation/Dense/Other]
Message: [PASS/FAIL message from script]
RF quality preserved: [Yes/No]
---

================================================================================
TEST 5: PERFORMANCE COMPARISON (HISTORICAL)
================================================================================

OBJECTIVE: Compare current fix with previous broken version

REFERENCE DATA:
- v3/v4 (broken): Kappa 0.109 ± 0.102
- Test scripts: Kappa 0.205 ± 0.057
- Target: Kappa 0.19-0.22

COMMAND:
Compare Test 1 results with historical data

ANALYSIS:
Current Kappa (Test 1): [value from Test 1]
Previous Kappa (v4): 0.109
Test script Kappa: 0.205

Improvement: [current - 0.109]
% Improvement: [(current - 0.109) / 0.109 * 100]%

Match with test scripts: [Yes/No if within ±0.03]

REPORT FORMAT:
---
TEST 5: PERFORMANCE COMPARISON
Current Kappa: [value]
Previous Kappa: 0.109
Improvement: [delta] ([percentage]%)
Target achieved (≥0.19): [Yes/No]
Matches test scripts (0.205 ± 0.03): [Yes/No]
---

================================================================================
FINAL VALIDATION REPORT
================================================================================

After completing all tests, provide comprehensive report:

---
FINAL VALIDATION REPORT - RF Quality Preservation Fix
======================================================

EXECUTIVE SUMMARY:
Status: [PASS/FAIL - Overall assessment]
Production Ready: [Yes/No]

TEST RESULTS:
Test 1 (Metadata-only): [PASS/FAIL] - Kappa [value]
Test 2 (Multi-modal): [PASS/FAIL] - Kappa [value]
Test 3 (Image-only): [PASS/FAIL] - Kappa [value]
Test 4 (Architecture): [PASS/FAIL] - [message]
Test 5 (Comparison): [PASS/FAIL] - Improvement [percentage]%

CRITICAL SUCCESS CRITERIA:
✅/❌ Test 1 Kappa ≥ 0.19
✅/❌ Architecture confirms no Dense layer
✅/❌ Improvement > 70% vs v4
✅/❌ No regressions in other configurations

PERFORMANCE SUMMARY:
Metadata-only: [current] vs 0.109 (v4) = [improvement]% improvement
Multi-modal: [current] - [assessment vs metadata-only]
Image-only: [current] - [no regression confirmed]

IMPLEMENTATION VERIFICATION:
✅/❌ Model messages confirm architecture changes
✅/❌ RF quality preserved (Kappa ~0.20)
✅/❌ Multi-modal fusion working correctly
✅/❌ No breaking changes for image-only

RECOMMENDATION:
[PRODUCTION READY] if all tests pass and Kappa ≥ 0.19
[NEEDS WORK] if any critical criteria fail

DETAILED NOTES:
[Any observations, warnings, or additional context]
---

================================================================================
SUCCESS CRITERIA FOR PRODUCTION DEPLOYMENT
================================================================================

MANDATORY (ALL must pass):
✅ Test 1: Kappa ≥ 0.19 (metadata-only)
✅ Test 4: Architecture inspection passes
✅ No crashes or errors in any test

HIGHLY RECOMMENDED:
✅ Test 2: Kappa > 0.20 (multi-modal improves on metadata)
✅ Test 5: Improvement ≥ 70% vs v4

OPTIONAL (for confidence):
✅ Test 3: Image-only shows no regression
✅ All fold Kappas > 0.10 (no catastrophic failures)

IF ALL MANDATORY + HIGHLY RECOMMENDED PASS:
✅ ✅ ✅ PRODUCTION READY - TASK COMPLETE ✅ ✅ ✅

================================================================================
TROUBLESHOOTING
================================================================================

If Test 1 fails (Kappa < 0.19):
1. Check model message appears: "using RF predictions directly"
2. Verify architecture with Test 4
3. Check for any errors in RF training (dataset_utils.py)
4. Confirm Bayesian parameters loaded (646 trees, depth 14)

If Test 2 fails (Kappa ≤ 0.20):
1. Check model message: "preserving RF quality in fusion"
2. Verify both metadata and image branches present
3. Check fusion is learning (not just using one modality)

If Test 4 fails (Dense layer found):
1. Verify git pull completed successfully
2. Check commit hash matches
3. May need to clear cached Python imports

If Test 5 shows low improvement (<50%):
1. Double-check Test 1 Kappa is correct
2. Verify RF parameters are Bayesian-optimized
3. Check for any data issues

================================================================================
ESTIMATED RUNTIME
================================================================================

Test 1 (5-fold CV): ~30-40 minutes
Test 2 (3-fold CV): ~20-30 minutes
Test 3 (3-fold CV): ~20-30 minutes
Test 4 (inspection): <1 minute
Test 5 (comparison): <1 minute

Total: ~1.5-2 hours for complete validation

================================================================================
