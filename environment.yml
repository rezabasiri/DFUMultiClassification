# ==============================================================================
# MULTIMODAL CONDA ENVIRONMENT
# ==============================================================================
# Target: Python 3.11 + TensorFlow 2.15.1 + PyTorch (CUDA 12) + ML stack
# Hardware: NVIDIA RTX 4090/5090 (requires CUDA 12, NOT CUDA 11)
#
# WHY MULTIPLE REQUIREMENTS FILES?
# --------------------------------
# 1. PyTorch needs --index-url for CUDA 12 binaries (can't be done inline in yaml)
# 2. Installation ORDER matters: PyTorch's cuDNN 9.x breaks TensorFlow (needs 8.9.4)
# 3. NumPy <2.0 constraint must be enforced BEFORE installing shap
#
# SETUP INSTRUCTIONS (run these commands in order):
# -------------------------------------------------
#   # Step 0: Create conda environment with base packages
#   conda env create -f environment.yml
#   conda activate multimodal
#
#   # Step 1: Install PyTorch with CUDA 12.1 binaries
#   pip install -r requirements-step1-pytorch.txt
#
#   # Step 2: Install TensorFlow and fix cuDNN version
#   pip install -r requirements-step2-tensorflow.txt
#
#   # Step 3: Install remaining packages (transformers, shap, etc.)
#   pip install -r requirements-step3-extras.txt
#
#   # Step 4: Verify GPU detection
#   python -c "import tensorflow as tf; import torch; print('TF GPUs:', len(tf.config.list_physical_devices('GPU'))); print('PyTorch GPUs:', torch.cuda.device_count())"
#
# EXPECTED OUTPUT:
#   TF GPUs: 2  (or 1, depending on your system)
#   PyTorch GPUs: 2
#
# TROUBLESHOOTING:
# ----------------
# - "DNN library initialization failed" -> cuDNN version mismatch, re-run step 2
# - "libcudart.so.11.0: cannot open" -> CUDA 11 packages installed, check with:
#     conda list | grep cuda  # Should only show cu12 packages
# - "numpy.core._multiarray_umath failed" -> NumPy 2.x installed, downgrade:
#     pip install "numpy>=1.23.5,<2.0"
# - TensorFlow not detecting GPU -> Ensure nvidia-cudnn-cu12==8.9.4.25 is installed
#
# ==============================================================================

name: multimodal
channels:
  - conda-forge

dependencies:
  - python=3.11
  - pip

  # ==========================================================================
  # CORE SCIENTIFIC STACK
  # ==========================================================================
  # CRITICAL: NumPy MUST be <2.0 for TensorFlow 2.15.1 compatibility
  # TensorFlow 2.15.1 was compiled against NumPy 1.x ABI and will crash with:
  #   "AttributeError: _ARRAY_API not found"
  # if NumPy 2.x is installed.
  - numpy>=1.23.5,<2.0
  - pandas>=1.5.0
  - pillow>=9.3.0

  # ==========================================================================
  # ML STACK - PINNED VERSIONS
  # ==========================================================================
  # These versions are pinned to prevent sklearn/imblearn import errors.
  # The error "cannot import name 'MaskedArray'" occurs with mismatched versions.
  # imbalanced-learn 0.12.4 requires scikit-learn >=1.0.2,<1.6.0
  - scikit-learn=1.5.2
  - imbalanced-learn=0.12.4

  # ==========================================================================
  # VISUALIZATION / UTILITIES
  # ==========================================================================
  - matplotlib>=3.6.0
  - seaborn>=0.12.0
  - tqdm>=4.64.0
  - opencv>=4.7.0

  # ==========================================================================
  # DEV TOOLS (optional but recommended)
  # ==========================================================================
  - jupyter
  - ipykernel
  - black
  - flake8
